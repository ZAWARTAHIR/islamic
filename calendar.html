<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ramzan Calendar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/responsive.css">
    <link rel="stylesheet" href="assets/css/theme.css">
    <link rel="stylesheet" href="assets/css/lunar-global.css">
    <link rel="stylesheet" href="assets/css/calendar.css">
</head>
<body>

<nav class="navbar">
    <button id="navToggle" class="nav-toggle" aria-expanded="false" aria-label="Toggle navigation">
        <span class="hamburger" aria-hidden="true"></span>
    </button>
    <div class="nav-left" id="navLeft">
        <a href="index.html">Home</a>
        <a href="calendar.html">Calendar</a>
        <a href="timings.html">Timings</a>
        <a href="duas.html">Duas</a>
        <a href="zakat.html">Zakat</a>
        <a href="lunar.html">Lunar</a>
        <a href="about.html">About</a>
        <!-- mobile-only copy of right-aligned items so they appear inside hamburger menu -->
        <div class="nav-left-mobile-copy mobile-only" aria-hidden="true">
            <a href="contact.html">Contact</a>
        </div>
    </div>
    <div class="nav-right">
        <a href="contact.html" class="desktop-only">Contact</a>
        <!-- Theme toggle will be moved here by lunar.js if present -->
        <div id="navbarThemePlaceholder"></div>
    </div>
</nav>

<main class="container">
    <header>
        <div class="page-hero card"><img src="assets/images/islam.jpg" alt="Calendar hero"></div>
        <h1>Ramzan Calendar — Monthly View</h1>
        <p class="lead">Printable calendar with daily Sehri and Iftar times.</p>
    </header>

    <section class="selectors">
        <label>Country
            <select id="countrySelect"><option value="">Loading...</option></select>
        </label>
        <label>City
            <select id="citySelect"><option value="">Select Country</option></select>
        </label>
        <label>Calculation Method
            <select id="methodSelect">
                <option value="3">University of Islamic Sciences, Karachi</option>
                <option value="1">Shia Ithna-Ashari</option>
                <option value="2">ISNA</option>
                <option value="4">MWL</option>
                <option value="7">Tehran</option>
            </select>
        </label>

        <!-- <label><input type="checkbox" id="advancedToggle"> Advanced</label> -->

        <div id="advancedOptions" style="display:none;gap:8px;flex-wrap:wrap;display:flex;">
            <label>Shafaq
                <select id="shafaqSelect">
                    <option value="general">General</option>
                    <option value="true">True</option>
                    <option value="false">False</option>
                </select>
            </label>
            <label>Hijri Year
                <input id="hijriYearInput" type="number" value="1446" min="1400" max="1600">
            </label>
            <label>Hijri Month
                <input id="hijriMonthInput" type="number" value="7" min="1" max="12">
            </label>
            <!-- <label> Tune (comma-separated)
                <input id="tuneInput" type="text" placeholder="e.g. 5,3,5,7,9,-1,0,8,-6">
            </label> -->
            <!-- <label>Timezone
                <input id="timezoneInput" type="text" value="UTC">
            </label> -->
            <!-- <label>Calendar Method
                <select id="calendarMethodSelect">
                    <option value="UAQ">UAQ</option>
                    <option value="Other">Other</option>
                </select>
            </label> -->
        </div>
        <!-- <label>Tune (comma-separated)
            <input id="tuneInput" type="text" placeholder="e.g. 5,3,5,7,9,-1,0,8,-6"> -->
        <!-- </label>
        <label>Timezone
            <input id="timezoneInput" type="text" value="UTC">
        </label>
        <label>Calendar Method
            <select id="calendarMethodSelect">
                <option value="UAQ">UAQ</option>
                <option value="Other">Other</option>
            </select>
        </label> -->
    </section>

    <!-- 24-hour format checkbox above calendar -->
    <div class="calendar-controls">
        <label>
            <input type="checkbox" id="use24HourFormat"> Use 24-hour format
        </label>
    </div>

    <section id="calendarContainer" class="calendar-container">
        <!-- Calendar days will render here -->
    </section>

    <div class="actions">
        <button id="downloadCalendar">Download Calendar</button>
    </div>
    
    <section class="card-grid">
        <article class="info-card">
            <h3>Calculation Notes</h3>
            <p>Timings may be based on local astronomical calculations (Fajr/Sunset angles) or mosque schedules; verify with local authority.</p>
        </article>
        <article class="info-card">
            <h3>Printable Tips</h3>
            <p>Use the Download button for a clean calendar PDF; prints perfectly on A4 portrait paper.</p>
        </article>
        <article class="info-card">
            <h3>Hijri Conversion</h3>
            <p>This calendar uses precomputed Hijri-Gregorian mapping; visual moon sightings may differ locally.</p>
        </article>
    </section>
</main>

<footer class="footer">
    <div class="footer-inner">
        <div class="footer-links">
            <a href="index.html">Home</a>
            <a href="calendar.html">Calendar</a>
            <a href="timings.html">Timings</a>
            <a href="duas.html">Duas</a>
            <a href="zakat.html">Zakat</a>
            <a href="about.html">About</a>
            <a href="contact.html">Contact</a>
        </div>
        <div class="footer-meta">
            <div class="social"><a href="#">Twitter</a><a href="#">Facebook</a><a href="#">Instagram</a></div>
            <div style="margin-top:6px"><a href="seo/sitemap.xml">Sitemap</a> · <a href="seo/robots.txt">Robots</a> · <a href="privacy.html">Privacy</a></div>
            <div style="margin-top:8px">© 2026 Ramzan Calendar</div>
        </div>
    </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="assets/js/storage.js"></script>
<script src="assets/js/country-city.js"></script>
<script src="assets/js/api-service.js"></script>
<script src="assets/js/calendar.js"></script>
<script src="assets/js/main.js"></script>
<script src="assets/js/lunar.js"></script>
<script>
document.getElementById('downloadCalendar').addEventListener('click', async function() {
    const calendarContainer = document.getElementById('calendarContainer');
    
    if (!calendarContainer || calendarContainer.children.length === 0) {
        alert('Please select a country and city first to generate the calendar.');
        return;
    }

    // Check if we're on mobile and temporarily force desktop view for download
    const isMobile = window.innerWidth < 900;
    let originalContent = '';
    
    if (isMobile) {
        // Store original mobile content
        originalContent = calendarContainer.innerHTML;
        
        // Force desktop table view for download
        const country = document.getElementById('countrySelect').value;
        const city = document.getElementById('citySelect').value;
        
        if (country && city) {
            // Re-render as desktop table with proper styling for download
            const use24HourCheckbox = document.getElementById('use24HourFormat');
            const use24Hour = use24HourCheckbox ? use24HourCheckbox.checked : false;
            
            // Get the data from the last rendered data
            if (window.lastCalendarData) {
                const table = document.createElement('table');
                table.className = 'timings-table download-table';
                table.style.cssText = `
                    width: 100%;
                    min-width: 600px;
                    table-layout: fixed;
                    margin: 0;
                    border-collapse: collapse;
                    background: #ffffff;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                `;
                
                const thead = document.createElement('thead');
                thead.innerHTML = '<tr><th style="width: 10%">Day</th><th style="width: 25%">Hijri Date</th><th style="width: 25%">Gregorian Date</th><th style="width: 20%">Sehri End</th><th style="width: 20%">Iftar</th></tr>';
                table.appendChild(thead);
                
                const tbody = document.createElement('tbody');
                window.lastCalendarData.forEach(d => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${d.day}</td><td>${d.hijriDate}</td><td>${d.gregorianDate}</td><td>${formatTime(d.sehri, use24Hour)}</td><td>${formatTime(d.iftar, use24Hour)}</td>`;
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                calendarContainer.innerHTML = '';
                calendarContainer.appendChild(table);
            }
        }
    }

    try {
        // Generate canvas from calendar container with settings optimized for full table capture
        const canvas = await html2canvas(calendarContainer, {
            scale: 1.5,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff',
            width: calendarContainer.scrollWidth,
            height: calendarContainer.scrollHeight,
            scrollX: 0,
            scrollY: 0,
            windowWidth: calendarContainer.scrollWidth,
            windowHeight: calendarContainer.scrollHeight
        });

        // Create PDF in A4 portrait for better calendar layout
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4'); // portrait, millimeters, A4
        
        // Use JPEG with quality compression for smaller file size
        const imgData = canvas.toDataURL('image/jpeg', 0.85); // JPEG with 85% quality
        const pdfWidth = pdf.internal.pageSize.getWidth();  // 210mm in portrait
        const pdfHeight = pdf.internal.pageSize.getHeight(); // 297mm in portrait
        
        // Calculate dimensions to fit the full table in A4 with proper margins
        const canvasAspectRatio = canvas.width / canvas.height;
        
        // For calendar tables, prioritize fitting full width with margins
        const maxWidth = pdfWidth - 20;  // 190mm usable width (10mm margins)
        const maxHeight = pdfHeight - 20; // 277mm usable height
        
        let imgWidth, imgHeight;
        
        // Fit to width first, then scale height
        imgWidth = maxWidth;
        imgHeight = maxWidth / canvasAspectRatio;
        
        // If height exceeds page, scale down proportionally
        if (imgHeight > maxHeight) {
            imgHeight = maxHeight;
            imgWidth = maxHeight * canvasAspectRatio;
        }
        
        // Center the image on the page
        const x = (pdfWidth - imgWidth) / 2;
        const y = (pdfHeight - imgHeight) / 2;
        
        pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);
        
        // Get location info for filename
        const countrySelect = document.getElementById('countrySelect');
        const citySelect = document.getElementById('citySelect');
        const countryName = countrySelect.options[countrySelect.selectedIndex]?.text || 'Unknown';
        const cityName = citySelect.options[citySelect.selectedIndex]?.text || 'Unknown';
        
        const filename = `Ramzan_Calendar_${cityName}_${countryName}.pdf`;
        pdf.save(filename);
        
    } catch (error) {
        console.error('Error generating PDF:', error);
        alert('Error generating calendar PDF. Please try again.');
    } finally {
        // Restore original mobile content if it was changed
        if (isMobile && originalContent) {
            calendarContainer.innerHTML = originalContent;
        }
    }
});

// Helper function for time formatting (same as in calendar.js)
function formatTime(timeString, use24Hour = false) {
    if (!timeString || timeString === '--') return timeString;

    const cleanTime = timeString.replace(/\s*\(.*$/,'').trim();
    const timeMatch = cleanTime.match(/^(\d{1,2}):(\d{2})$/);
    if (!timeMatch) return cleanTime;

    const hours = parseInt(timeMatch[1]);
    const minutes = timeMatch[2];

    if (use24Hour) {
        return `${hours.toString().padStart(2, '0')}:${minutes}`;
    } else {
        const period = hours >= 12 ? 'PM' : 'AM';
        const displayHours = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours;
        return `${displayHours}:${minutes} ${period}`;
    }
}
</script>

</body>
</html>
